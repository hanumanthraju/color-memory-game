!function(){angular.module("memoryGameApp",["ngRoute","ui.bootstrap","ngCookies"]).config(["$routeProvider",function(e){e.when("/",{templateUrl:"template/home.html",controller:"GameController"}).otherwise({redirectTo:"/"})}]).run(["$rootScope",function(e){e.noOfCards=8}])}(),function(){"use strict";angular.module("memoryGameApp").controller("GameController",["$scope","$rootScope","GameService","Utils",function(e,t,a,r){var o=t.noOfCards;e.colorCards=a.getColorCards(o);var n=function(e,t){return t+" (keyCode: "+(window.event?e.keyCode:e.which)+")"};e.onKeyDown=function(t){e.onKeyDownResult=n(t,"Key down")},e.restart=function(){if(Element.retrieve("pairs-opened","value")!=o){var t=confirm("Restarting the game will loose your progress. Are you sure you want to restart?");t&&(e.cardsSequence=a.getCards(o),e.interval=resetGame(interval))}else e.cardsSequence=getCards(),e.interval=resetGame(interval)},e.submitScore=function(){if(!Element.hasClassName("submit-score","disabled")){Element.up("user-name").removeClassName("error"),Element.next("user-name").update(""),Element.up("user-email").removeClassName("error"),Element.next("user-email").update("");var e=Form.Element.getValue("user-name"),t=Form.Element.getValue("user-email"),a=!1;e&&e.strip().length||(Element.up("user-name").addClassName("error"),Element.next("user-name").update("Please enter your name."),a=!0),t&&t.strip().length||(Element.up("user-email").addClassName("error"),Element.next("user-email").update("Please enter your email address."),a=!0),t&&!validateEmail(t.strip())&&(Element.up("user-email").addClassName("error"),Element.next("user-email").update("Please enter a valid email address."),a=!0),a||(Element.addClassName("submit-score","disabled"),sendToServer(0,e.strip(),t.strip()))}},e.sendToServer=function(e,t,a){var r={appId:"memory-game",userid:e,user:t,email:a,score:Element.retrieve("current-score","value")||0,moves:Element.retrieve("total-moves","value")||0,time:Element.retrieve("time-lapsed","value")||0};new Ajax.Request("saveScore.php",{method:"post",parameters:{obj:JSON.stringify(r)},onSuccess:function(e){var t=e.responseText||"no response text";t=JSON.parse(t),t.success?(Element.update("welcome-user-address","Hi"),Element.update("welcome-user-name",t.name),Element.show("not-you"),createCookie("memory-game-userid",t.userid,10),createCookie("memory-game-name",t.name,10),createCookie("memory-game-email",t.email,10)):alert("Something went wrong. Please try again."),Element.removeClassName("submit-score","disabled"),l(),showScores(r.score)},onFailure:function(){alert("Something went wrong. Please try again."),Element.removeClassName("submit-score","disabled")}})},e.showScores=function(e){s("modal1"),new Ajax.Request("getScores.php",{method:"get",onSuccess:function(t){var a=t.responseText||"no response text";if(a=JSON.parse(a),Element.update("ranking"," "),a.success&&a.rows&&a.rows.length>0){var r="";a.rows.map(function(t,a){var o=readCookie("memory-game-userid")==t.id;o&&Element.update("ranking",(e?"You scored "+e+" in this game! ":"")+"You currently rank "+(a+1)+" in the leaderboard."),r+="<tr "+(o?'class="highlight"':"")+">",r+="<td>"+(a+1)+"</td>",r+="<td>"+t.name+"</td>",r+="<td>"+t.email+"</td>",r+="<td>"+t.score+"</td>",r+="</tr>"}),Element.update("table-body",r)}else Element.update("table-body",'<tr><td colspan="4">No scores submitted yet.</td></tr>')},onFailure:function(){alert("Something went wrong. Please try again.")}})};var m=function(e){Element.removeClassName("modal-backdrop","open"),Element.removeClassName(e,"open"),$$("#"+e+" input").each(function(e){Form.Element.setValue(e,"")})},s=function(e){Element.addClassName("modal-backdrop","open"),Element.addClassName(e,"open")},l=function(){Element.removeClassName("modal-backdrop","open"),$$(".modal").each(function(e){m(e.id)})}}])}(),function(){"use strict";angular.module("memoryGameApp").factory("GameService",function(){return{getColorCards:function(e){for(var t=[],a=1;e>=a;a++)t.push(a),t.push(a);return t.sort(function(){return.5-Math.random()}),t}}})}(),function(){angular.module("memoryGameApp").factory("UserService",["$http","$q","transformRequestAsFormPost",function(e,t,a){var r="http://"+document.domain+"/"||"http://ng.local.memory.game/";return e.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded",{getScores:function(){var a=t.defer(),o=e({method:"get",url:r+"getScores.php"});return o.success(function(e){a.resolve(e)}).error(function(e,t){a.reject(e)}),a.promise},saveScore:function(o){var n=t.defer(),m=e({method:"post",url:r+"saveScore.php",transformRequest:a,data:o});return m.success(function(e){n.resolve(e)}).error(function(e,t){n.reject(e)}),n.promise},getUserStats:function(o){var n=t.defer(),m=e({method:"post",url:r+"getUserStats.php",transformRequest:a,data:o});return m.success(function(e){n.resolve(e)}).error(function(e,t){n.reject(e)}),n.promise}}}])}(),function(){angular.module("memoryGameApp").factory("transformRequestAsFormPost",function(){function e(e,a){var r=a();r["Content-type"]="application/x-www-form-urlencoded; charset=utf-8";var o=t(e);return o}function t(e){if(!angular.isObject(e))return null==e?"":e.toString();var t=[];for(var a in e)if(e.hasOwnProperty(a)){var r=e[a];t.push(encodeURIComponent(a)+"="+encodeURIComponent(null==r?"":r))}var o=t.join("&").replace(/%20/g,"+");return o}return e})}(),function(){"use strict";angular.module("memoryGameApp").factory("Utils",["$window",function(e){function t(e){var t=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return t.test(e)}function a(t,a,r){if(r){var o=new Date;o.setTime(o.getTime()+24*r*60*60*1e3);var n="; expires="+o.toGMTString()}else var n="";e.document.cookie=t+"="+a+n+"; path=/"}function r(t){for(var a=t+"=",r=e.document.cookie.split(";"),o=0;o<r.length;o++){for(var n=r[o];" "==n.charAt(0);)n=n.substring(1,n.length);if(0==n.indexOf(a))return n.substring(a.length,n.length)}return null}function o(e){a(e,"",-1)}return{validateEmail:t,createCookie:a,readCookie:r,eraseCookie:o}}])}(),function(){angular.module("memoryGameApp").directive("gameCardsDirective",["Utils","$rootScope","$timeout","$window","GameService","UserService",function(e,t,a,r,o,n){function m(m,s,l){var u,i=o.getColorCards(t.noOfCards),d=function(e,t){e.addClassName("open"),Element.setStyle(e,{backgroundImage:'url("img/colour'+i[t]+'.gif")'})},c=function(e){e.removeClassName("open"),Element.setStyle(e,{backgroundImage:""})},p=function(e){e.removeClassName("open"),e.addClassName("closed"),Element.setStyle(e,{backgroundImage:"none"})},v=function(t){$$("#game-board .card").each(function(e){e.removeClassName("open"),e.removeClassName("closed"),e.removeClassName("selected"),Element.setStyle(e,{backgroundImage:'url("img/card_bg.gif")'})}),$$("#game-board .card")[0].addClassName("selected"),Element.store("current-score","value",0),Element.store("total-moves","value",0),Element.store("pairs-opened","value",0),Element.store("time-lapsed","value",0),Element.update("current-score",0),Element.update("total-moves",0),Element.update("pairs-opened",0),Element.update("time-lapsed","00:00"),Element.store("games-played","value",0),Element.store("best-score","value",0),Element.update("games-played",0),Element.update("best-score",0);var a=e.readCookie("memory-game-userid");return a&&n.getUserStats({userid:a}).then(function(e){e.success&&e.obj&&(Element.store("games-played","value",parseInt(e.obj.count)),Element.store("best-score","value",parseInt(e.obj.max)),Element.update("games-played",e.obj.count),Element.update("best-score",e.obj.max))}),t&&clearInterval(t),setInterval(g,1e3)},g=function(){var e=Element.retrieve("time-lapsed","value")+1;Element.store("time-lapsed","value",e);var t=Math.floor(e/60);t=10>t?"0"+t:t,t=t>60?Math.floor(t/60)+":"+t%60:t;var a=e%60;a=10>a?"0"+a:a,Element.update("time-lapsed",t+":"+a)},E=function(e){Element.removeClassName("modal-backdrop","open"),Element.removeClassName(e,"open"),$$("#"+e+" input").each(function(e){Form.Element.setValue(e,"")})},f=function(e){Element.addClassName("modal-backdrop","open"),Element.addClassName(e,"open")},C=function(){Element.removeClassName("modal-backdrop","open"),$$(".modal").each(function(e){E(e.id)})},y=function(t){var a=Element.retrieve("games-played","value")+1;Element.store("games-played","value",a),Element.update("games-played",a);var r=Element.retrieve("best-score","value");r=Math.max(r,Element.retrieve("current-score","value")),Element.store("best-score","value",r),Element.update("best-score",r),clearInterval(t);var o=e.readCookie("memory-game-userid"),n=e.readCookie("memory-game-name"),m=e.readCookie("memory-game-email");e.readCookie("memory-game-userid")?b(o,n,m):(f("modal"),Element.update("final-score",Element.retrieve("current-score","value")||0))},h=function(){if(!Element.hasClassName("submit-score","disabled")){Element.up("user-name").removeClassName("error"),Element.next("user-name").update(""),Element.up("user-email").removeClassName("error"),Element.next("user-email").update("");var t=Form.Element.getValue("user-name"),a=Form.Element.getValue("user-email"),r=!1;t&&t.strip().length||(Element.up("user-name").addClassName("error"),Element.next("user-name").update("Please enter your name."),r=!0),a&&a.strip().length||(Element.up("user-email").addClassName("error"),Element.next("user-email").update("Please enter your email address."),r=!0),a&&!e.validateEmail(a.strip())&&(Element.up("user-email").addClassName("error"),Element.next("user-email").update("Please enter a valid email address."),r=!0),r||(Element.addClassName("submit-score","disabled"),b(0,t.strip(),a.strip()))}},b=function(t,a,r){var o={appId:"memory-game",userid:t,user:a,email:r,score:Element.retrieve("current-score","value")||0,moves:Element.retrieve("total-moves","value")||0,time:Element.retrieve("time-lapsed","value")||0};n.saveScore(o).then(function(t){t.success?(Element.update("welcome-user-address","Hi"),Element.update("welcome-user-name",t.name),Element.show("not-you"),e.createCookie("memory-game-userid",t.userid,10),e.createCookie("memory-game-name",t.name,10),e.createCookie("memory-game-email",t.email,10)):alert("Something went wrong. Please try again."),Element.removeClassName("submit-score","disabled"),C(),k(o.score)})},k=function(t){f("modal1"),n.getScores().then(function(a){if(Element.update("ranking"," "),a.success&&a.rows&&a.rows.length>0){var r="";a.rows.map(function(a,o){var n=e.readCookie("memory-game-userid")==a.id;n&&Element.update("ranking",(t?"You scored "+t+" in this game! ":"")+"You currently rank "+(o+1)+" in the leaderboard."),r+="<tr "+(n?'class="highlight"':"")+">",r+="<td>"+(o+1)+"</td>",r+="<td>"+a.name+"</td>",r+="<td>"+a.email+"</td>",r+="<td>"+a.score+"</td>",r+="</tr>"}),Element.update("table-body",r)}else Element.update("table-body",'<tr><td colspan="4">No scores submitted yet.</td></tr>')})};m.restart=function(){if(Element.retrieve("pairs-opened","value")!=t.noOfCards){var e=confirm("Restarting the game will loose your progress. Are you sure you want to restart?");e&&(i=o.getColorCards(t.noOfCards),u=v(u))}else i=o.getColorCards(),u=v(u)},m.submitScore=function(){h()},m.showScores=function(){h()},m.notYou=function(){e.eraseCookie("memory-game-userid"),e.eraseCookie("memory-game-name"),e.eraseCookie("memory-game-email"),Element.update("welcome-user-address",e.readCookie("memory-game-userid")?"Hi":"Welcome"),Element.update("welcome-user-name",e.readCookie("memory-game-userid")?e.readCookie("memory-game-name"):"Guest"),Element.toggle("not-you",e.readCookie("memory-game-userid")?!0:!1),u=v(u)},a(function(){angular.element(document).ready(function(){Element.update("welcome-user-address",e.readCookie("memory-game-userid")?"Hi":"Welcome"),Element.update("welcome-user-name",e.readCookie("memory-game-userid")?e.readCookie("memory-game-name"):"Guest"),Element.toggle("not-you",e.readCookie("memory-game-userid")?!0:!1),angular.element(r).bind("keydown",function(a){if(!Element.hasClassName("modal","open")&&!Element.hasClassName("game-board","disabled")){var r=Selector.findElement($$("#game-board .card"),".selected"),o=r.previousSiblings().size(),n=t.noOfCards||8,m=n/2,s=2*n-1,l=a.which||a.keyCode;switch(l){case Event.KEY_LEFT:a.preventDefault(),o&&(r.removeClassName("selected"),r.previous().addClassName("selected"));break;case Event.KEY_RIGHT:a.preventDefault(),o!=s&&(r.removeClassName("selected"),r.next().addClassName("selected"));break;case Event.KEY_DOWN:a.preventDefault(),s>=o+m&&(r.removeClassName("selected"),r.next(m-1).addClassName("selected"));break;case Event.KEY_UP:a.preventDefault(),o-m>=0&&(r.removeClassName("selected"),r.previous(m-1).addClassName("selected"));break;case Event.KEY_RETURN:a.preventDefault();var i=Selector.findElement($$("#game-board .card"),".open");if(r.hasClassName("closed"));else if(i)if(i==r);else{d(r,o);var v=Element.retrieve("total-moves","value")+1;Element.store("total-moves","value",v),Element.update("total-moves",v),Element.addClassName("game-board","disabled"),setTimeout(function(){Element.removeClassName("game-board","disabled");var e,a,o=Element.getStyle(i,"background-image"),n=Element.getStyle(r,"background-image");o==n?(e=Element.retrieve("current-score","value")+1,Element.store("current-score","value",e),Element.update("current-score",e),a=Element.retrieve("pairs-opened","value")+1,Element.store("pairs-opened","value",a),Element.update("pairs-opened",a),p(i),p(r),a==t.noOfCards&&y(u)):(e=Element.retrieve("current-score","value")-1,Element.store("current-score","value",e),Element.update("current-score",e),c(i),c(r))},250)}else d(r,o)}Element.update("welcome-user-address",e.readCookie("memory-game-userid")?"Hi":"Welcome"),Element.update("welcome-user-name",e.readCookie("memory-game-userid")?e.readCookie("memory-game-name"):"Guest"),Element.toggle("not-you",e.readCookie("memory-game-userid")?!0:!1)}}),s.on("click",function(t){var a=t.target;Element.match(a,".modal-backdrop")&&C(),(Element.match(a,".close")||Element.match(a,".cancel"))&&E(Element.up(a,".modal").id),"submit-score"==a.id&&h(),Element.match(a,".play-again")&&(E(Element.up(a,".modal").id),u=v(u)),"show-scores"==a.id&&k(),"not-you"==a.id&&(t.preventDefault(),e.eraseCookie("memory-game-userid"),e.eraseCookie("memory-game-name"),e.eraseCookie("memory-game-email"),Element.update("welcome-user-address",e.readCookie("memory-game-userid")?"Hi":"Welcome"),Element.update("welcome-user-name",e.readCookie("memory-game-userid")?e.readCookie("memory-game-name"):"Guest"),Element.toggle("not-you",e.readCookie("memory-game-userid")?!0:!1),u=v(u))}),u=v(u)})})}return{restrict:"E",scope:{gameCards:"=gameCards"},link:m,templateUrl:"template/game.html"}}])}();